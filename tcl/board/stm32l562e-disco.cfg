# This is a STM32L562E discovery board with a single STM32L562QEI6Q chip.
# http://www.st.com/en/evaluation-tools/stm32l562e-dk.html

# This is for using the onboard STLINK
source [find interface/stlink.cfg]

transport select hla_swd

# increase working area to 96KB
set WORKAREASIZE 0x18000

# enable stmqspi
if {![info exists OCTOSPI1]} {
	set OCTOSPI1 1
}

source [find target/stm32l5x.cfg]

# OCTOSPI initialization
# octo: 8-line mode
proc octospi_init { octo } {
	global a
	mmw 0x4002104C 0x000000FF 0				;# RCC_AHB2ENR |= GPIOAEN-GPIOHEN (enable clocks)
	mmw 0x40021050 0x00000100 0				;# RCC_AHB3ENR |= OSPI1EN (enable clocks)
	sleep 1									;# Wait for clock startup

	mmw 0x40007004 0x00000200 0				;# PWR_CR2 |= IOSV (required for use of GPOIG, cf. RM0438)

	# PA02: OCSPI1_NCS, PA03: OCSPI1_CLK, PB02: OCSPI1_DQS, PC00: OCSPI1_IO7, PC03: OCSPI1_IO6, PC02: OCSPI1_IO5,
	# PC01: OCSPI1_IO4, PA06: OCSPI1_IO3, PA07: OCSPI1_IO2, PB00: OCSPI1_IO1, PB01: OCSPI1_IO0

	# PA07:AF10:V, PA06:AF10:V, PA03:AF10:V, PA02:AF10:V, PB02:AF10:V, PB01:AF10:V
	# PB00:AF10:V, PC03:AF10:V, PC02:AF10:V, PC01:AF10:V, PC00:AF03:V
	# Port A: PA07:AF10:V, PA06:AF10:V, PA03:AF10:V, PA02:AF10:V
	mmw 0x42020000 0x0000A0A0 0x00005050	;# MODER
	mmw 0x42020008 0x0000F0F0 0x00000000	;# OSPEEDR
	mmw 0x4202000C 0x00000000 0x0000F0F0	;# PUPDR
	mmw 0x42020020 0xAA00AA00 0x55005500	;# AFRL
	# Port B: PB02:AF10:V, PB01:AF10:V, PB00:AF10:V
	mmw 0x42020400 0x0000002A 0x00000015	;# MODER
	mmw 0x42020408 0x0000003F 0x00000000	;# OSPEEDR
	mmw 0x4202040C 0x00000000 0x0000003F	;# PUPDR
	mmw 0x42020420 0x00000AAA 0x00000555	;# AFRL
	# Port C: PC03:AF10:V, PC02:AF10:V, PC01:AF10:V, PC00:AF03:V
	mmw 0x42020800 0x000000AA 0x00000055	;# MODER
	mmw 0x42020808 0x000000FF 0x00000000	;# OSPEEDR
	mmw 0x4202080C 0x00000000 0x000000FF	;# PUPDR
	mmw 0x42020820 0x0000AAA3 0x0000555C	;# AFRL

	# OCTOSPI1: memory-mapped 1-line read mode with 4-byte addresses
	mww 0x44021130 0x00001000				;# OCTOSPI_LPTR: deactivate CS after 4096 clocks when FIFO is full
	mww 0x44021000 0x3040000B				;# OCTOSPI_CR: FMODE=0x1, APMS=1, FTHRES=0, FSEL=0, DQM=0, TCEN=0
	mww 0x44021008 0x01190100				;# OCTOSPI_DCR1: MTYP=0x1, FSIZE=0x19, CSHT=0x01, CKMODE=0
	mww 0x4402100C 0x00000001				;# OCTOSPI_DCR2: PRESCALER=1

	mww 0x44021108 0x00000000				;# OCTOSPI_TCR: SSHIFT=0, DHQC=0, DCYC=0x0
	mww 0x44021100 0x01003101				;# OCTOSPI_CCR: DMODE=0x1, ABMODE=0x0, ADSIZE=0x3, ADMODE=0x1, ISIZE=0x0, IMODE=0x1
	mww 0x44021110 0x00000013				;# OCTOSPI_IR: INSTR=READ4B

	if { $octo == 1 } {
		stmqspi cmd $a 1 0x71 0x00 0x00 0x00 0x00			;# Read Conf. Reg. 2, addr 0x00000000: DOPI, SOPI bits
		stmqspi cmd $a 0 0x06								;# Write Enable
		stmqspi cmd $a 1 0x05								;# Read Status Register
		stmqspi cmd $a 0 0x72 0x00 0x00 0x00 0x00 0x02		;# Write Conf. Reg. 2, addr 0x00000000: DTR OPI enable

		# OCTOSPI1: memory-mapped 8-line read mode with 4-byte addresses
		mww 0x44021000 0x3040000B				;# OCTOSPI_CR: FMODE=0x3, APMS=1, FTHRES=0, FSEL=0, DQM=0, TCEN=1, EN=1
		mww 0x44021108 0x10000006				;# OCTOSPI_TCR: SSHIFT=0, DHQC=1, DCYC=0x6
		mww 0x44021100 0x2C003C1C				;# OCTOSPI_CCR: DTR, DMODE=0x4, ABMODE=0x0, ADSIZE=0x3, ADMODE=0x4, ISIZE=0x1, IMODE=0x4
		mww 0x44021110 0x0000EE11				;# OCTOSPI_IR: INSTR=OCTA DTR Read

		flash probe $a							;# reload configuration from CR, TCR, CCR, IR register values

		stmqspi cmd $a 0 0x06								;# Write Enable
		stmqspi cmd $a 1 0x05 0x00 0x00 0x00 0x00			;# Read Status Register (note dummy address in 8-line mode)
		stmqspi cmd $a 0 0x04								;# Write Disable
		stmqspi cmd $a 1 0x05 0x00 0x00 0x00 0x00			;# Read Status Register (note dummy address in 8-line mode)
		stmqspi cmd $a 1 0x71 0x00 0x00 0x00 0x00			;# Read Conf. Reg. 2, addr 0x00000000: DOPI, SOPI bits
	}
}

$_TARGETNAME configure -event reset-init {
	mmw 0x40022000 0x00000003 0x0000000C	;# 3 WS for 72 MHz HCLK
	sleep 1
	mmw 0x40021000 0x00000100 0x00000000	;# HSI on
	mww 0x4002100C 0x01002432				;# RCC_PLLCFGR 72 MHz: PLLREN=1, PLLM=4, PLLN=36, PLLR=2, HSI
	mww 0x40021008 0x00008001				;# always HSI, APB1: /1, APB2: /1
	mmw 0x40021000 0x01000000 0x00000000	;# PLL on
	sleep 1
	mmw 0x40021008 0x00000003 0x00000000	;# switch to PLL
	sleep 1

	adapter speed 24000

	octospi_init 1
}

