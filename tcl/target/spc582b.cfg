# script for SPC584B family

# Core family configuration
source [find target/spc58.cfg]

set _CHIPNAME   spc582b
set _ENDIAN     big

if { [info exists TAPID] } {
   set _TAPID  $TAPID
} else {
    set _TAPID  0x11140041
}

set _TARGETNAME $_CHIPNAME.tap

#
# Configure JTAG TAP
#
jtag newtap $_CHIPNAME tap \
	-irlen 6 \
	-ircapture 0x1 \
	-irmask 0x3f \
	-expected-id $_TAPID


# Create the target core 
target create $_CHIPNAME.cpu powerpc \
	-endian $_ENDIAN \
	-chain-position $_TARGETNAME


#$_CHIPNAME.cpu configure \
#	-event reset-init   { force_reset; disable_watchdog; invalidate_cache }

$_CHIPNAME.cpu configure -event reset-init {
#    echo "LOG: reset-init event"
    init_target
}

$_CHIPNAME.cpu configure -event gdb-attach {
#    echo "LOG: gdb-attach event"
    reset init
    init_target
}

# Work-area is a space in RAM used for flash programming
# By default use 4kB
if { [info exists WORKAREASIZE] } {
   set _WORKAREASIZE $WORKAREASIZE
} else {
   set _WORKAREASIZE 0x1000
}

# Allow overriding the Flash bank size
if { [info exists FLASH_SIZE] } {
    set _FLASH_SIZE $FLASH_SIZE
} else {
    # autodetect size
    set _FLASH_SIZE 0x100000
}

$_CHIPNAME.cpu configure -work-area-phys 0x400A8000 -work-area-size $_WORKAREASIZE

# flash size will be probed
set _FLASHNAME_0 $_CHIPNAME.0.flash
flash bank $_FLASHNAME_0 spc582b 0x00FC0000 $_FLASH_SIZE 0 0 $_CHIPNAME.cpu

set _FLASHNAME_1 $_CHIPNAME.1.flash
flash bank $_FLASHNAME_1 spc582b 0x00800000 0x10000 0 0 $_CHIPNAME.cpu

proc init_target { } {
	disable_watchdog
	init_regs
	echo "initialize work area from 0x400A8000 to 0x400A8FFF"
	# work area must be initialized by clear_memory
	clear_memory 0x400A8000 0x400A8FFF
	echo "initialize RAM from 0x400A9000 to 0x400BFFFF"
	# non working area can be initilized by fast ram_fill command
	# usage: ram_fill start_addr size_kb [value_32bit]
	ram_fill 0x400A9000 0x17000
	#setup IVOPR points to 0x400A9000
	echo "setup IVOPR points"
	setspr 0x3F 0x400A9000
}
